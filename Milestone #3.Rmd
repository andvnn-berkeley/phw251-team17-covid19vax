---
title: 'PHW251 Team Project: Milestone #3'
subtitle: 'Scenario Two: COVID Vaccination Progress'
author: "Saira Mayet, Jessica Pak, Andrew Nguyen"
date: "10/28/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
```

**Import Statement**

```{r import statement}

# from Milestone #2
file_path_vax <- "https://data.chhs.ca.gov/dataset/ead44d40-fd63-4f9f-950a-3b0111074de8/resource/ec32eece-7474-4488-87f0-6e91cb577458/download/covid19vaccinesbyzipcode_test.csv"
file_path_county <- "https://raw.githubusercontent.com/Averysaurus/reproducable_examples-/main/ca_county_demographics.csv"

vax_temp <- read.csv(file_path_vax)
county_temp <- read.csv(file_path_county)

# subset data to only include variables of interest
vax <- vax_temp %>% select(-c("vaccine_equity_metric_quartile", "local_health_jurisdiction", "vem_source", 10:13))
county <- county_temp %>% select(c("name", "med_age"))
```

**1. Subset data, as needed:**

Partial subsetting of data was already performed in Milestone #2 (see import statement above).
We are keeping the following variables in these datasets:

    - County: name, median age
    - Vax: date, ZIP , county, vaccine equity quartile, population 12+, number person fully vaccinated, number partially vaccinated

Now we will subset for the latest date of data, as the CDPH's "COVID-19 Vaccines Administered by Zip Code" excel sheet is a continually-updated dataset.
```{r subset latest data}
vax_latest <- vax %>%
  mutate(date = as_date(as_of_date)) %>%
  filter(date == max(date)) %>%
  select( - as_of_date)
```


\newpage    
**2. Create new variables needed for analysis**

Clean variables:

    - Create variable: percent eligible population partially vaccinated = # of persons partially vaccinated / population 12+ (at county level)
    - Create variable: percent eligible population fully vaccinated = # of persons fully vaccinated / population 12+ (at county level)
    - Replace NA via mean imputation: county-level means of fully and partially vaccinated that will be used to replace NA values in zip-code
    - Remove variables: some values for 12+ population does not make sense (values equal 0 or are smaller than the number of people fully/partially vaccinated)
    - Merging relational data: county demographic dataset with vaccine administration dataset using key variable "county"
    - Rename variables, re-select variables to keep for final clean dataset


We will remove missing values from fully/partially vaccinated persons columns by replacing NAs with the mean proportion vaccinated values calculated at the county level (mean imputation) to create our new fully/partially vaccinated percentage variables.

```{r mean imputation}
<<<<<<< HEAD
  
=======

>>>>>>> d485395190243688a19145d39bba09d1690ff343
vax_latest <- vax_latest %>% 
  group_by(county) %>%
  mutate(
    countyfull = round(((sum(persons_fully_vaccinated, na.rm = T)/sum(age12_plus_population))*100), digits = 2),
    countypartial = round(((sum(persons_partially_vaccinated, na.rm = T)/sum(age12_plus_population))*100), digits = 2)
    ) %>% 
  ungroup() %>% 
  mutate(
    percent_full = round((persons_fully_vaccinated/age12_plus_population)*100, digits = 2),
    percent_partial = round((persons_partially_vaccinated/age12_plus_population)*100, digits = 2)
    ) %>% 
  mutate(percent_full = ifelse(is.na(percent_full), countyfull, percent_full),
         percent_partial = ifelse(is.na(percent_partial), countypartial, percent_partial))
<<<<<<< HEAD


#remove data from ZIPs w/ higher positive tests than total population

vax_temp <- vax_latest %>%
  mutate(partial_count = ifelse(persons_fully_vaccinated > age12_plus_population, NA, persons_partially_vaccinated),
         partial_count = ifelse(persons_partially_vaccinated > age12_plus_population, NA, persons_partially_vaccinated),
         fully_count = ifelse(persons_fully_vaccinated > age12_plus_population, NA, persons_fully_vaccinated),
         eligible_pop = ifelse(persons_fully_vaccinated > age12_plus_population, NA, age12_plus_population))

#aggregate counts & percentages by county 

vax_temp <- vax_temp %>%
  group_by(county) %>%
  mutate(county_partial = sum(partial_count, na.rm = T) / sum(eligible_pop, na.rm = T),
         county_fully = sum(fully_count, na.rm = T) / sum(eligible_pop, na.rm = T)) %>%
  ungroup()

#impute % on eligible population for ZIPs w/ missing vaccination counts (originally NA or removed b/c more than eligible population) + remove ZIPs that have 0 eligible population counts

vax_temp <- vax_temp %>%
  mutate(partial_count = round(ifelse(is.na(partial_count), county_partial * age12_plus_population, partial_count), 2),
         fully_count = round(ifelse(is.na(fully_count), county_fully * age12_plus_population, fully_count), 2),
         eligible_pop = age12_plus_population) %>%
  filter(age12_plus_population != 0)

#create new aggregate counts & percentages at county level

vax_temp <- vax_temp %>%
  group_by(county) %>%
  mutate(county_partial_new = sum(partial_count, na.rm = T) / sum(eligible_pop, na.rm = T),
         county_fully_new = sum(fully_count, na.rm =T) / sum(eligible_pop, na.rm = T),
         county_eligible_pop = sum(eligible_pop)) %>%
  ungroup()

vax_aggregate <- vax_temp %>%
  distinct(county, .keep_all = T) %>%
  select(county, vaccine_equity_metric_quartile, county_partial_new, county_fully_new, county_eligible_pop)
=======

# from here need to remove rows with 12+ population numbers that are 0 or smaller than vaccinated people numbers, calculate county averages again (this time without NAs), remove unnecessary columns, merge with county dataset, and rename column names
>>>>>>> d485395190243688a19145d39bba09d1690ff343
```



Merging both county and vax_latest dataset:
```{r}

```

\newpage 
**4. Data dictionary based on clean dataset** 


**Variable Name** | **Definition** 
--------------|-----------
Latest Date   | Date of latest data available for vaccination statistics
County Name   | Names of the 58 counties
Median Age    | Median age of population per county as recorded by United States American Community Survey (ACS) data.
Percentage fully vaccinated | number of eligible people fully vaccinated (2+ doses for mRNA vaccine, 1 dose for adenovirus vaccine) divided by number of persons 12+ 
Percent partially vaccinated | number of eligible people partially vaccination (1 dose for mRNA vaccine) divide by number of persons 12+